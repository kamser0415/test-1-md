# Kafka

![image_161.png](image_161.png)

![image_163.png](image_163.png)

파티션과 키의 갯수가 똑같으면 파티션이 키의 hash로 번갈아가면서 저장할 수 있지만,
키보다 파티션 갯수가 많아지면 파티션의 일관성이 사라집니다.

데이터 이슈인 데이터 손실과 같은 그외 다양한 경우는 추가적인 욥션과 코드가 표기

카프카의 주요 옵션인 broker,replication,ISR에 대한 설명이 있습니다.

복제는 제일 중요한 옵션으로 문제가 생겨도 가용성을 보장하는 옵션이기 때문이다.

브로커는 3개로 브로커마다 각각 서버에서 동작하는게 중요하고, 리플리케이션의 개수는 브로커 갯수를 넘을 수 없습니다.

브로커가 문제가 발생하면 해당 브로커가 가진 파티션은 복구할 수 없습니다.

브로커 서버가 3대이고 리플리케이션은 2대로 이줄때 파티션하나 불타도 리플리케이션 파이션에서 돌아갈 수 있습니다.

프로듀서는 토픽의 파티션 데이터를 전달할예정한다.

![image_164.png](image_164.png)

프로듀서가 이벤트를 토픽에 저장할 때 저장되는 위치가 leader라고 합니다.

![image_165.png](image_165.png)

`ack = 0` 파티션에 데이터를 저장하고, 응답 값을 받지 않는다.
그래서 파티션에 등록된지 확인할 수 없고, 나머지 파티션은 정상적으로 복제되었는지 알 수 없다.
장점은 속도는 빠르지만 데이터 유실 가능성이 있습니다.

![image_166.png](image_166.png)

`ack = 1` 리더 파티션에 데이터를 저장하고 응답 값을 확인할 수 있습니다.
나머지 파티션에 적용이 된지 알 수 없다.

리더파티션이 오류가 발생하면 나머지 슬레이브 파티션에 데이터 전송을 하지 못하므로 데이터 유실 가능성이 잇다

`ack = all`에 복제가 잘 되었는지 복제 파티션에서도 응답값을 받습니다.  
데이터 유실은 거지 없지만 0 과 1에 비해 확인하는 부분이 많기때문에 속도가 현저히 느리다는 단점이 있다.

레플리케이션이 많으면 좋은 건만 아니다.  
브로커의 리소스 사용량도 늘어납니다. 카프카에 들어오는 데이터량과 Retention 데이트 저장시간을 잘 생각해서, replication 갯수는 3을 추천한다.

```Actionscript
 3개의 브로커 사용시 3개 레플리케이션을 추천하는 이유는 운영상의 이슈(데이터의 유실, 복구 불가 등)를 최대한 배제하기 위해서입니다. 
카프카 브로커 버젼 업그레이드같은 상황을 예를 들 수 있을 것 같습니다. 카프카 브로커 버젼을 업그레이드 하려면 브로커 3대를 한대씩 종료/실행(여러번)해야합니다. 만약 1대의 브로커를 종료했을때 운이 좋지 않아서 동시에 나머지 replica를 가진 broker가 down된다면 해당 토픽은 복구되지 못합니다. 
Kafka broker가 설치된 서버의 가용성이 99.9%라고 가정하더라도 365일중 shutdown되는 시간은 무려 8시간이므로 카프카 브로커 버젼을 업그레이드 하는 작업을 하던 도중 서버가 동시에 죽을 가능성이 없다고 보기는 힘듭니다.
빅데이터 운영에 있어서 중요한 것은 장애가 발생하는지/안하는지가 아니라 장애가 발생했을 시에 복구가 가능한지/불가능 한지가 더 중요하다고 생각됩니다. 이를 고려하셔서 replication factor를 정하시면 될것입니다.
데이터 유실이 되면 치명적이라고 생각된다면 3이상으로 설정하셔서 운영하시고, 만약 일부 유실이 되도 무관한 데이터라면 리소스 효율화를 위해 replication factor을 2나 1로 낮추어 운영하셔도 좋은 방법이라 봅니다! 
```

카프카 브로커에 저장된 레코드는 지울 수 없다.
```Actionscript
카프카의 토픽에 저장되는 데이터인 record는 immutable 즉, 불변의 특징을 가지고 있습니다. 그러므로 이미 들어간 record에 대해 직접 지우거나 수정할 수 있는 방법은 없습니다. 다만 토픽의 용량(retention byte)이나 시간(retention date)에 따라 삭제되는 정책을 선언할 수 있습니다.
```  


카프카 컨슈머가 데이터를 가져오는 것을 폴링이라 한다.  