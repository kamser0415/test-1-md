# Mutual Exclusion-배타제어

멀티쓰레드 환경에서 동일한 자원에 접근할 수 있기에 문제가 발생합니다.  
  
이런 문제를 피하는 제어를 베타 제어라고 합니다.  
  
## Concurrent  
공유 자원을 제어하는 오브젝트를 말합니다. 자바에는 ConcurrentHashMap 등이 있습니다.  
  
내부 로직에 따라 성능 저하가 발생할 수 있습니다. 
  
만약 하나의 쓰레드에서만 write하고 나머지 쓰레드에서는 read만 한다면 사용할 이유는 없습니다.  
읽기만 하는건 동시성 문제가 발생할 수 없습니다.  
  

## Lock
특정 코드 구간은 반드시 하나의 Thread만 실행할 수 있도록 제어합니다.  
그 구간을 critical section 이라고 하며, 만약 이 구간이 길다면 다른 쓰레드는 대기하기에 성능저하가 발생합니다.  
  
최악의 경우엔 차라리 싱글 스레드가 더 빠를 수 있습니다.  
이유는 해당 구간에 락이 걸려있는지 확인하는 비용, 락을 거는 비용, 락을 해제하는 비용등이 발생하기 때문입니다.  
  
그래서 최대한 Lock 범위를 줄여야하며, 그래서 나온 개념이 `One Process, One Thread Architecture`입니다.  

## Lock-Free
Lock을 사용하지 않고 배타제어를 하는데 목적을 두는 방식입니다.  
> 키워드  
> + interlocked.Increment(),
> + Atomic Operation,
> + Lock-Free 알고리즘, Non-Blocking 알고리즘, CAS(compare and set)  
>   
  
## 기타방법
+ 레디스의 특정 key에 데이터를 넣고 Pub/Sub을 이용하는 방법
+ 빠르게 통신할 필요가 없다면 AWS SQS 같은 Queue에 넣고 데이터를 추가됐을 때 특정 Topic으로 Event를 받는 방법이 있습니다.
+ 데이터를 보내려는 서버가 알아서 다른 서버에 보내주는게 아니라 올려놓고 알아서 가져가는 방식도 있습니다.  
  
  

## 멀티 쓰레드와 멀티태스킹을 알아야하는 이유
서버에서 효율적으로 사용자의 요청을 처리하기 위해서 멀티 프로세스를 통한 방식보다 멀티 쓰레드 방식이 저렴하기 때문입니다.  
저렴한 이유를 정리하면
+ 프로세스를 할당하는 것보다 쓰레드를 추가하는게 비용이 적다.
  + 프로세스를 추가하려면 메모리 공간을 운영체제에게 할당 받아야한다.
  + 프로세스는 별도의 메모리 공간을 갖기 때문에 컨택스트 스위치 발생시 캐시 초기화가 생긴다.
  + 프로세스를 돌리기 위해 발생하는 오버헤드가 생긴다.
  
대신, 쓰레드는 프로세스가 할당 받은 메모리 공간을 효율적으로 사용하기 위해 공유하는 메모리 공간이 `heap`,`Data`,`Text`영역을 사용하게 됩니다.  
  
자원의 연산이 오작동을 방지하기 위해서 멀티쓰레드 환경에서 베타 제어로 방지를 합니다.  
1. Concurrent
2. Lock
3. Lock-Free
  
사용자 요청이 많아져서 하나의 서버로 소화하기 어려울 경우 성능을 높이는 스케일업, 서버를 늘리는 스케일 아웃을 선택한다.  
이걸 데이터베이스 시점으로 보면 결제 데이터베이스, 상품 품목 데이터베이스등으로 나누어 관리한다는 의미가 되며 
각자 기능에 맞는 서버로 나누는게 효율적이기 때문입니다.  
  
결제 데이터베이스도 결국은 동시성 문제는 해결해야하는 문제가 발생합니다. 그건 위에 설명이 되어있고 
결제 데이터베이스에서 주문이 완료되면 상품 품목 데이터베이스에 재고 수량을 감소해야합니다.  
이렇게 두 서버에서 통신하기 위해서 사용하는 방식이 HTTP, TCP방식이 있다.  
  
두 데이터베이스를 그대로 연결하는 것보다 중간에 서비스 프로그램을 만들어서 관리하는데 
프로그래밍 언어가 달라지면 통신하는데 방식에 고민을 해야합니다.  
  
결국 레디스를 사용하는 이유는 서버가 한대던, 서버가 수십대던 상관없이 데이터베이스 프로세스인 RDBMS의 동시성을 제어하기 위해
사용하는 방법일 뿐이다.  
그런데 레디스를 사용하는 것보다 데이터베이스를 통해 동시성을 제어하는 방식이 옳을 수 있으니 그게 Lock이다.  
  

-- 1차 피드백
1. 베타 제어보다는 상호 배제(Mutual Exclusion),동기화 (Synchronization)의 용어가 더 적합하다.
2. 두 프로세스를 통신하는 방법이 HTTP,TCP는 추상화된 개념이기에 RESTfull API와 gRPC등의 프로토콜 방식을 말하는게 더 명확하다.  
3. 레디스를 사용하는 이유에서 오류가 있다. 레디스는 인메모리 데이터베이스로 RDBMS의 동시성을 제어하는게 목적이 아니라 
캐싱이나 메세지 큐와 같은 방식으로 사용하는 것.  
  
