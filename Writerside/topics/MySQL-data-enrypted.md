# MySQL TDE: 알아서 암호화를 제공한다.

## 정의

투명 데이터 암호화(TDE)는 파일 수준에서 데이터를 암호화하는 방식으로 사용자 입장에서 암호화를 위한 추가작업이 없습니다.
`TDE(Transparent Data Encryption)` 이라고 하며 또한 `Data at Rest Encryption`이라고 합니다.  
`at Rest`는 메모리(`In-Process`) 나 네트워크 전송(`In-Transit`) 단계아 아닌 디스크에 저장(`At Rest`)된 단계에서만 암호화된다는 의미로 사용됩니다.

## 사용목적

물리적 도난(예: 드라이브 도난)이나 서버가 손상되었을 때 파일이 유출되는 것을 방지하는 기술입니다. TDE는 데이터가 저장될 때 대칭 키로 암호화하고, 데이터가 조회될 때 이를 복호화합니다. TDE는 백업 및
트랜잭션 로그 파일도 암호화합니다.

## 동작원리
1. **마스터 키 획득**
    - MySQL 서버는 키링 플러그인을 통해 마스터 키를 가져온다.

2. **테이블 스페이스 키 생성**
    - 암호화된 테이블이 생성될 때, MySQL은 임의로 테이블 스페이스 키를 생성한다.

3. **테이블 스페이스 키 암호화 및 저장**
    - MySQL은 마스터 키를 사용하여 테이블 스페이스 키를 암호화하고, 이를 테이블 스페이스의 헤더에 저장한다.

4. **데이터 암호화**
    - 데이터를 저장할 때, 테이블 스페이스의 헤더에 저장된 암호화된 키를 사용하여 모든 데이터를 암호화한다.

5. **테이블 스페이스 키 보안**
    - 테이블 스페이스 키는 외부에 노출되지 않기 때문에 변경할 필요가 없다.
    - 그러나 마스터 키는 외부에 노출될 가능성이 있으므로 주기적으로 변경해야 한다.

6. **마스터 키 변경**
    - 기존 마스터 키로 암호화된 테이블 스페이스 키를 복호화한다.
    - 복호화된 테이블 스페이스 키를 새로운 마스터 키로 다시 암호화하여 저장한다.
    - 이 과정에서는 테이블 내의 데이터를 복호화한 후 다시 암호화한다. 이로 인해 사용자 쿼리 처리 성능에 상당한 영향을 미칠 수 있다.

7. **이전 마스터 키 제거**
    - 모든 암호화된 테이블의 헤더가 새로운 마스터 키로 변경되면, 이전 마스터 키는 제거한다.

### 암호화와 성능
TDE 암호화는 디스크에만 암호화되며, 데이터를 읽을 때 MySQL 서버에서 복호화하는 과정이 필요합니다. 이로 인해 테이블 구조 변경이나 새로운 데이터를 읽는 경우에는 복호화 지연이 발생할 수 있습니다.
성능 저하는 버퍼풀에 데이터가 적재된 경우에는 없지만, 새로운 데이터를 읽어야 할 때 복호화 지연이 발생할 수 있습니다.

### 암호화와 압축
데이터 암호화와 압축이 모두 이루어질 때, 압축이 먼저 실행됩니다. 암호화를 먼저 하게 되면 랜덤한 바이트 배열을 갖게 되어 압축률이 떨어집니다.  
  
### 레플리카 서버와 복제  
TDE를 사용할 경우, 소스 서버와 레플리카 서버는 각각 다른 마스터 키를 가져야 합니다. 이는 원격으로 키 관리 솔루션을 사용하더라도 해당됩니다. 소스 코드에서 레플리카 서버로 마스터 키가 직접 복제되지 않기 때문에 각 서버는 서로 다른 암호화 데이터를 가지게 됩니다. 따라서 마스터 키를 변경할 때는 레플리카 서버에 소스 서버의 마스터 키가 전달되는 것이 아니라, 각각의 서버가 독립적으로 새로운 마스터 키를 발급받습니다. 이로 인해 데이터 복구나 백업을 위해서는 키링 파일을 별도로 보관해야 합니다.

### 테이블 스페이스 이동시 동작방식
`FLUSH TABLE` 명령어로 테이블 스페이스를 `Export`할 수 있는데, `TDE`를 사용하는 중이라면 추가 과정이 있습니다.  
  
1. MySQL 서버는 임시 마스터 키를 발급하여 `table_name.cfp`파일에 기록
2. 테이블 스페이스키를 기존 마스터키를 사용하여 복호화한다.
3. 임시 마스터키를 사용하여 테이블 스페이스 키를 암호화후 헤더에 저장
4. 따라서 이동기능 사용할때 `*.cfp`파일도 같이 이동해야한다.


### 언두로그와 리두 로그 암호화
언두 로그와 리두 로그는 메모리에서 복호화된 평문으로 관리되었기에 암호화가 적용안되었지만,
8.0.16 버전부터 `innodb_undo_log_encrypt`,`innodb_redo_log_encrypt` 시스템 변수를 사용하여 
언두로그와 리두로그를 암호화 한 생태로 저장할 수 있습니다.  
  
기존 테이블과 차이점은 활성화 전 언두로그와 리두로그를 모두 암호화하지 않습니다.
암호화를 활성화시점으로 파일로 암호화하여 관리하며 
리두로그와 언두로그 파일을 위한 프라이빗 키를 헤더에 저장하게 됩니다.  

### 바이너리 로그 암호화  
`at Rest`으로 디스크에 저장할때 암호화되는 방식인 `TDE`는 복제를 위한 바이너리 로그를 전달하는 과정은 
네크워크 연결 구간이므로 SSL을 사용하는 방식으로 사용합니다.  
  
바이너리 로그는 테이블 스페이스 키와 같이 로그 파일 키로 암호화하여 디스크에 저장하고, 
파일 키는 바이너리 로그 암호화 키로 암호화해서 로그파일 헤더에 저장합니다.

