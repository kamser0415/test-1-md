# 책 요구사항 05-01
  
## 목표
1. 책 생성, 대출 ,반납 API를 온전히 개발하며 지금까지 다루었던 모든 개념을 실습해본다.  
2. 객체지향적으로 설계하기 위한 연관관계를 이해하고, 연관관계를 이해하고, 연관관계의 다양한 옵션에 대해 이해한다.
3. JPA에서 연관관계를 매핑하는 방법을 이해하고, 연관관계를 사용해 개발할 때와 사용하지 않고 개발할 때의 차이점을 이해한다.  
  
## 요구사항  

### 책 등록  
API 명세  
+ HTTP Method: POST
+ HTTP Path: /book  
+ HTTP Body: (JSON)  
```json
{
  "name": String // 책이름
}
```
테스트 코드를 작성하는 이유는 기능에 대한 검증, 유연한 설계를 할 수 있도록 집중의 방향을 
인터페이스로 하기 때문이다.  
  
그러면 단순한 검증보다는 설계에 대해 고민을 하려면 인터페이스에 집중을 해야하기 때문에 
그 방식중에 하나가 `TDD` 라는 방식이고 입니다.  
  
그러면 구조에 대해서 고민을 해야한다.  

외부 요청을 받을 계층은 `Controller`가 단순한 값에 대한 검증을 하고 
책을 등록하다는 기능을 서비스 계층에서 전달합니다.  
  
서비스 계층은 내부적으로 비스니스인 책 이름에 대한 자세한 검증을 합니다. 이때 서비스 검증은 
해당 서비스에 특화된 비즈니스 검증이기 때문에 도메인에서 하는 검증과는 다른 
비즈니스로 보여줄 수 있는 검증과 에러메세지를 가지고 있어야합니다.  
  
도메인은 실제 비즈니스 로직을 실행하는 내부 로직이 포함되어있으며 그 결과를 서비스에게 전달하거나 
내부 상태를 변경합니다.  
  
그 결과를 리포지토리에 저장합니다.  
  
```SQL
create table book
(
    id   bigint auto_increment,
    name varchar(255),
    primary key (id)
);
```  
1. `@Column` 기본 문자열 길이가 255이기 때문에 동일할 경우 `@Column`을 생략할 수 있다.
2. 문자열 필드는 최적화를 해야하는 경우가 아니라면 조금 여유롭게 설정하는 것이 좋다.  
    이유는 미래에는 더 긴 데이터가 들어올 수 있기 때문입니다. 데이터가 많은 상태에서 늘리기는 어렵다.
  
`ORM`를 통해서 `Hibernate` 사용할 때는 테이블을 기준으로 엔티티를 생성해야합니다.  
  
위 조건으로 엔티티를 생성합니다.  
  
**JPA 객체를 새로 만들면 , 객체를 저장하는 Repository도 같이 만듭니다.**  
  
**DTO는 API스펙에 따라 만드는게 달라진다.**  
결국은 객체라는건 사용하는 계층이 어딘지에 따라서 계층에 필요한 기능을 가지고 있으면 좋다.  
  
### 대출 기능
사용자가 책을 빌릴수 있다.  
다른 사람이 그 책을 먼저 빌렸다면 빌릴 수 없다.  
    
**강사님과 차이점**  
테이블의 구조를 만들 때, 책이라는 테이블에 빌린 사람의 정보를 입력하려고 했다.  
```Java
//저장된 책 엔티티를 조회후 상태를 수정하려고 했습니다.
Book book = repository.findByName("클린 코드");
book.loanToUser("빌린 사람이름"):
```  
이런식으로 하려고 했는데 사실 생각해보면, 유저나 책에 빌린 정보를 기입하는건 물론 불필요한 조인을 줄일 수 있겠지만, 
관련된 일이 있을 때마다 책과 유저에 추가되면 관리가 어렵고 누구에게 정보를 입력할지 어렵다.  
  
따라서 유저의 대출 기록을 저장하는 테이블을 강사님은 만들려고 하신것.  
이걸 테스트 코드로 작성할때 테이블 구조에 대해서 생각을 해보면,  
  
**1안.**   
TDD 관점과 테스트 코드로 볼때 행동에 대해서 테스트를 하려고 한다.  
책 대출 기능에는 책 빌리는 것, 없을 경우에는 못빌린다는 메세지를 전달해야한다.  
  

```Java
@Entity
public class UserLoanHistory {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private long userId;
    private String bookName;

    private boolean isReturn;
    
}
```
이렇게 설정할 경우 `true = 1`, `false = 0`으로 잘 매핑됩니다.  
  
